# ğŸ”Œ æ’ä»¶ç³»ç»Ÿè®¾è®¡æ–¹æ¡ˆ

> åŸºäºå®¢æˆ·éœ€æ±‚ï¼šæ’ä»¶åŒ–æ¶æ„ + ä»£ç ç¼–è¾‘å™¨ + äº‘ç«¯æ’ä»¶å¸‚åœº

---

## ğŸ“‹ å®¢æˆ·éœ€æ±‚åˆ†æ

### æ ¸å¿ƒéœ€æ±‚
1. **æ’ä»¶åŒ–æ¶æ„**ï¼šæŠŠå°åŒ…æ‹¦æˆªç­‰åŠŸèƒ½åšæˆæ’ä»¶
2. **æ’ä»¶å¼€å‘è‡ªç”±**ï¼šå¼€å‘è€…å¯ä»¥è‡ªå·±å†™æ’ä»¶ï¼Œæ§åˆ¶ç•Œé¢å’ŒåŠŸèƒ½
3. **ä»£ç ç¼–è¾‘å™¨**ï¼šå‰ç«¯å®ç°åœ¨çº¿ç¼–å†™å’Œè¿è¡ŒJSä»£ç 
4. **æ’ä»¶å¸‚åœº**ï¼šäº‘ç«¯æ’ä»¶çš„å®‰è£…å’Œå¸è½½

---

## ğŸ¯ æ’ä»¶ç³»ç»Ÿæ¶æ„

### 1. æ’ä»¶æ ‡å‡†å®šä¹‰

#### æ’ä»¶å…ƒæ•°æ® (plugin.json)
```json
{
  "name": "packet-interceptor",
  "displayName": "å°åŒ…æ‹¦æˆªå™¨",
  "version": "1.0.0",
  "author": "å¼€å‘è€…åç§°",
  "description": "æ‹¦æˆªå¹¶åˆ†ææ¸¸æˆå°åŒ…",
  "main": "index.js",
  "icon": "icon.png",
  "ui": {
    "hasPanel": true,
    "panelComponent": "PacketPanel.vue",
    "menuIcon": "ğŸ“¦",
    "menuLabel": "å°åŒ…ç›‘æ§"
  },
  "permissions": [
    "game:connect",
    "game:packet:read",
    "game:packet:write",
    "storage:read",
    "storage:write"
  ],
  "dependencies": {},
  "repository": "https://github.com/xxx/packet-interceptor",
  "homepage": "https://xxx.com",
  "keywords": ["packet", "interceptor", "seer"]
}
```

#### æ’ä»¶å…¥å£æ–‡ä»¶ (index.js)
```javascript
// æ’ä»¶å¿…é¡»å¯¼å‡ºçš„æ ‡å‡†æ¥å£
export default {
  // æ’ä»¶åç§°ï¼ˆå¿…éœ€ï¼‰
  name: 'packet-interceptor',
  
  // æ’ä»¶ç‰ˆæœ¬ï¼ˆå¿…éœ€ï¼‰
  version: '1.0.0',
  
  // æ’ä»¶æ¿€æ´»æ—¶è°ƒç”¨ï¼ˆå¿…éœ€ï¼‰
  activate(context) {
    console.log('æ’ä»¶å·²æ¿€æ´»:', this.name);
    
    // æ³¨å†Œå‘½ä»¤
    context.registerCommand('packet.start', () => {
      console.log('å¼€å§‹æ‹¦æˆªå°åŒ…');
    });
    
    // ç›‘å¬äº‹ä»¶
    context.on('game:packet:received', (packet) => {
      console.log('æ”¶åˆ°å°åŒ…:', packet);
    });
    
    // æ³¨å†ŒUIç»„ä»¶
    context.registerPanel({
      id: 'packet-panel',
      title: 'å°åŒ…ç›‘æ§',
      component: 'PacketPanel',
      icon: 'ğŸ“¦'
    });
  },
  
  // æ’ä»¶åœç”¨æ—¶è°ƒç”¨ï¼ˆå¯é€‰ï¼‰
  deactivate(context) {
    console.log('æ’ä»¶å·²åœç”¨');
  },
  
  // æ’ä»¶æä¾›çš„APIï¼ˆå¯é€‰ï¼‰
  api: {
    interceptPacket(packet) {
      // æ‹¦æˆªå°åŒ…çš„æ–¹æ³•
    },
    modifyPacket(packet, newData) {
      // ä¿®æ”¹å°åŒ…çš„æ–¹æ³•
    }
  }
};
```

#### Vueç»„ä»¶ç¤ºä¾‹ (PacketPanel.vue)
```vue
<template>
  <div class="packet-panel">
    <h3>å°åŒ…ç›‘æ§é¢æ¿</h3>
    <button @click="startCapture">å¼€å§‹æ•è·</button>
    <div v-for="packet in packets" :key="packet.id">
      {{ packet.data }}
    </div>
  </div>
</template>

<script setup>
import { ref, onMounted } from 'vue';

const packets = ref([]);

// è·å–æ’ä»¶API
const pluginAPI = window.$plugin.getAPI('packet-interceptor');

const startCapture = () => {
  pluginAPI.interceptPacket((packet) => {
    packets.value.push(packet);
  });
};

onMounted(() => {
  console.log('å°åŒ…é¢æ¿å·²æŒ‚è½½');
});
</script>
```

---

## ğŸ—ï¸ ç³»ç»Ÿå®ç°æ–¹æ¡ˆ

### 2. æ’ä»¶ç®¡ç†å™¨æ ¸å¿ƒ

#### æ’ä»¶ç®¡ç†å™¨ (src/plugins/PluginManager.ts)
```typescript
import { EventEmitter } from 'events';
import * as fs from 'fs';
import * as path from 'path';

interface Plugin {
  id: string;
  name: string;
  version: string;
  metadata: any;
  instance: any;
  context: PluginContext;
  enabled: boolean;
}

class PluginContext extends EventEmitter {
  private plugin: Plugin;
  private commands: Map<string, Function> = new Map();
  private panels: any[] = [];

  constructor(plugin: Plugin) {
    super();
    this.plugin = plugin;
  }

  // æ³¨å†Œå‘½ä»¤
  registerCommand(name: string, handler: Function) {
    this.commands.set(name, handler);
  }

  // æ³¨å†ŒUIé¢æ¿
  registerPanel(config: any) {
    this.panels.push(config);
    // é€šçŸ¥ä¸»è¿›ç¨‹æ›´æ–°UI
    this.emit('panel:registered', config);
  }

  // è·å–é…ç½®
  getConfig(key: string) {
    return this.plugin.metadata[key];
  }

  // ä¿å­˜æ•°æ®
  async saveData(key: string, value: any) {
    const dataPath = path.join(__dirname, `../../plugin-data/${this.plugin.id}`);
    await fs.promises.mkdir(dataPath, { recursive: true });
    await fs.promises.writeFile(
      path.join(dataPath, `${key}.json`),
      JSON.stringify(value)
    );
  }

  // è¯»å–æ•°æ®
  async loadData(key: string) {
    const filePath = path.join(__dirname, `../../plugin-data/${this.plugin.id}/${key}.json`);
    const data = await fs.promises.readFile(filePath, 'utf-8');
    return JSON.parse(data);
  }
}

export class PluginManager extends EventEmitter {
  private plugins: Map<string, Plugin> = new Map();
  private pluginsDir: string;

  constructor(pluginsDir: string) {
    super();
    this.pluginsDir = pluginsDir;
  }

  // åŠ è½½æ‰€æœ‰æ’ä»¶
  async loadPlugins() {
    const dirs = await fs.promises.readdir(this.pluginsDir);
    
    for (const dir of dirs) {
      const pluginPath = path.join(this.pluginsDir, dir);
      try {
        await this.loadPlugin(pluginPath);
      } catch (error) {
        console.error(`åŠ è½½æ’ä»¶å¤±è´¥: ${dir}`, error);
      }
    }
  }

  // åŠ è½½å•ä¸ªæ’ä»¶
  async loadPlugin(pluginPath: string) {
    // è¯»å–æ’ä»¶å…ƒæ•°æ®
    const metadataPath = path.join(pluginPath, 'plugin.json');
    const metadata = JSON.parse(
      await fs.promises.readFile(metadataPath, 'utf-8')
    );

    // åŠ¨æ€å¯¼å…¥æ’ä»¶
    const mainPath = path.join(pluginPath, metadata.main);
    const pluginModule = await import(mainPath);

    // åˆ›å»ºæ’ä»¶å®ä¾‹
    const plugin: Plugin = {
      id: metadata.name,
      name: metadata.displayName,
      version: metadata.version,
      metadata,
      instance: pluginModule.default,
      context: null as any,
      enabled: false
    };

    // åˆ›å»ºæ’ä»¶ä¸Šä¸‹æ–‡
    plugin.context = new PluginContext(plugin);

    // å­˜å‚¨æ’ä»¶
    this.plugins.set(plugin.id, plugin);

    // æ¿€æ´»æ’ä»¶
    await this.activatePlugin(plugin.id);
  }

  // æ¿€æ´»æ’ä»¶
  async activatePlugin(pluginId: string) {
    const plugin = this.plugins.get(pluginId);
    if (!plugin) {
      throw new Error(`æ’ä»¶ä¸å­˜åœ¨: ${pluginId}`);
    }

    if (plugin.enabled) {
      return;
    }

    // è°ƒç”¨æ’ä»¶çš„activateæ–¹æ³•
    await plugin.instance.activate(plugin.context);
    plugin.enabled = true;

    this.emit('plugin:activated', plugin);
  }

  // åœç”¨æ’ä»¶
  async deactivatePlugin(pluginId: string) {
    const plugin = this.plugins.get(pluginId);
    if (!plugin || !plugin.enabled) {
      return;
    }

    // è°ƒç”¨æ’ä»¶çš„deactivateæ–¹æ³•
    if (plugin.instance.deactivate) {
      await plugin.instance.deactivate(plugin.context);
    }

    plugin.enabled = false;
    this.emit('plugin:deactivated', plugin);
  }

  // è·å–æ‰€æœ‰æ’ä»¶
  getAllPlugins() {
    return Array.from(this.plugins.values()).map(p => ({
      id: p.id,
      name: p.name,
      version: p.version,
      enabled: p.enabled,
      metadata: p.metadata
    }));
  }

  // è·å–æ’ä»¶API
  getPluginAPI(pluginId: string) {
    const plugin = this.plugins.get(pluginId);
    return plugin?.instance.api;
  }
}
```

---

### 3. å‰ç«¯æ’ä»¶ç³»ç»Ÿ

#### å‰ç«¯æ’ä»¶API (web/src/composables/usePlugin.ts)
```typescript
import { ref, reactive } from 'vue';

interface PluginInfo {
  id: string;
  name: string;
  version: string;
  enabled: boolean;
  metadata: any;
}

export function usePlugin() {
  const plugins = ref<PluginInfo[]>([]);
  const activePlugin = ref<string | null>(null);

  // è·å–æ‰€æœ‰æ’ä»¶
  const loadPlugins = async () => {
    if (!window.$win) return;
    plugins.value = await window.$win.getAllPlugins();
  };

  // å¯ç”¨æ’ä»¶
  const enablePlugin = async (pluginId: string) => {
    await window.$win.enablePlugin(pluginId);
    await loadPlugins();
  };

  // ç¦ç”¨æ’ä»¶
  const disablePlugin = async (pluginId: string) => {
    await window.$win.disablePlugin(pluginId);
    await loadPlugins();
  };

  // å®‰è£…æ’ä»¶
  const installPlugin = async (pluginUrl: string) => {
    await window.$win.installPlugin(pluginUrl);
    await loadPlugins();
  };

  // å¸è½½æ’ä»¶
  const uninstallPlugin = async (pluginId: string) => {
    await window.$win.uninstallPlugin(pluginId);
    await loadPlugins();
  };

  return {
    plugins,
    activePlugin,
    loadPlugins,
    enablePlugin,
    disablePlugin,
    installPlugin,
    uninstallPlugin
  };
}
```

---

### 4. ä»£ç ç¼–è¾‘å™¨å®ç°

#### ä½¿ç”¨ Monaco Editor

**å®‰è£…ä¾èµ–ï¼š**
```bash
cd web
npm install monaco-editor
npm install @monaco-editor/react
```

#### ä»£ç ç¼–è¾‘å™¨ç»„ä»¶ (web/src/components/CodeEditor.vue)
```vue
<template>
  <div class="code-editor-container">
    <div class="editor-toolbar">
      <button @click="runCode" class="btn-run">
        <span>â–¶ï¸</span> è¿è¡Œä»£ç 
      </button>
      <button @click="saveCode" class="btn-save">
        ğŸ’¾ ä¿å­˜
      </button>
      <button @click="clearConsole" class="btn-clear">
        ğŸ—‘ï¸ æ¸…ç©ºæ§åˆ¶å°
      </button>
    </div>

    <div class="editor-content">
      <div class="editor-main">
        <MonacoEditor
          v-model="code"
          language="javascript"
          theme="vs-dark"
          :options="editorOptions"
          @change="handleCodeChange"
        />
      </div>

      <div class="console-panel">
        <div class="console-header">æ§åˆ¶å°è¾“å‡º</div>
        <div class="console-content">
          <div
            v-for="(log, index) in consoleLogs"
            :key="index"
            :class="['console-log', log.type]"
          >
            <span class="log-time">{{ log.time }}</span>
            <span class="log-message">{{ log.message }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref } from 'vue';
import MonacoEditor from '@monaco-editor/react';

const code = ref(`// ç¼–å†™ä½ çš„æ’ä»¶ä»£ç 
console.log('Hello, Plugin!');

// è®¿é—®æ¸¸æˆAPI
const gameClient = window.$game.newGameClient();

gameClient.on('_onRecvCallback', (packet) => {
  console.log('æ”¶åˆ°å°åŒ…:', packet);
});
`);

const consoleLogs = ref<Array<{ time: string; message: string; type: string }>>([]);

const editorOptions = {
  fontSize: 14,
  minimap: { enabled: false },
  automaticLayout: true,
  tabSize: 2,
  scrollBeyondLastLine: false
};

// è¿è¡Œä»£ç 
const runCode = () => {
  try {
    // æ•è·console.log
    const originalLog = console.log;
    const originalError = console.error;

    console.log = (...args) => {
      addLog(args.join(' '), 'info');
      originalLog.apply(console, args);
    };

    console.error = (...args) => {
      addLog(args.join(' '), 'error');
      originalError.apply(console, args);
    };

    // æ‰§è¡Œä»£ç 
    const func = new Function(code.value);
    func();

    // æ¢å¤console
    console.log = originalLog;
    console.error = originalError;

    addLog('ä»£ç æ‰§è¡Œå®Œæˆ', 'success');
  } catch (error: any) {
    addLog(`é”™è¯¯: ${error.message}`, 'error');
  }
};

// ä¿å­˜ä»£ç 
const saveCode = async () => {
  const fileName = `custom-plugin-${Date.now()}.mjs`;
  await window.$win.saveSeerjsFile(fileName, code.value);
  addLog(`ä»£ç å·²ä¿å­˜: ${fileName}`, 'success');
};

// æ¸…ç©ºæ§åˆ¶å°
const clearConsole = () => {
  consoleLogs.value = [];
};

// æ·»åŠ æ—¥å¿—
const addLog = (message: string, type: string = 'info') => {
  consoleLogs.value.push({
    time: new Date().toLocaleTimeString(),
    message,
    type
  });
};

const handleCodeChange = (value: string) => {
  code.value = value;
};
</script>

<style scoped>
.code-editor-container {
  display: flex;
  flex-direction: column;
  height: 100%;
  background: #1e1e1e;
}

.editor-toolbar {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #252526;
  border-bottom: 1px solid #3e3e42;
}

.editor-toolbar button {
  padding: 8px 16px;
  border: none;
  border-radius: 4px;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.3s;
}

.btn-run {
  background: #16a34a;
  color: white;
}

.btn-run:hover {
  background: #15803d;
}

.btn-save {
  background: #2563eb;
  color: white;
}

.btn-clear {
  background: #dc2626;
  color: white;
}

.editor-content {
  display: flex;
  flex: 1;
  overflow: hidden;
}

.editor-main {
  flex: 1;
  min-width: 0;
}

.console-panel {
  width: 400px;
  display: flex;
  flex-direction: column;
  border-left: 1px solid #3e3e42;
  background: #1e1e1e;
}

.console-header {
  padding: 10px;
  background: #252526;
  border-bottom: 1px solid #3e3e42;
  color: #cccccc;
  font-weight: 600;
}

.console-content {
  flex: 1;
  overflow-y: auto;
  padding: 10px;
}

.console-log {
  padding: 5px;
  margin-bottom: 5px;
  border-radius: 3px;
  font-family: 'Consolas', 'Monaco', monospace;
  font-size: 12px;
}

.console-log.info {
  color: #cccccc;
}

.console-log.success {
  color: #4ade80;
}

.console-log.error {
  color: #f87171;
  background: rgba(248, 113, 113, 0.1);
}

.log-time {
  color: #888;
  margin-right: 10px;
}
</style>
```

---

### 5. æ’ä»¶å¸‚åœºç•Œé¢

#### æ’ä»¶å¸‚åœºç»„ä»¶ (web/src/components/PluginMarket.vue)
```vue
<template>
  <div class="plugin-market">
    <div class="market-header">
      <h2>ğŸª æ’ä»¶å¸‚åœº</h2>
      <div class="search-bar">
        <input
          v-model="searchQuery"
          placeholder="æœç´¢æ’ä»¶..."
          @input="searchPlugins"
        />
      </div>
    </div>

    <div class="market-tabs">
      <button
        :class="['tab', { active: activeTab === 'all' }]"
        @click="activeTab = 'all'"
      >
        å…¨éƒ¨æ’ä»¶
      </button>
      <button
        :class="['tab', { active: activeTab === 'installed' }]"
        @click="activeTab = 'installed'"
      >
        å·²å®‰è£…
      </button>
      <button
        :class="['tab', { active: activeTab === 'featured' }]"
        @click="activeTab = 'featured'"
      >
        ç²¾é€‰æ¨è
      </button>
    </div>

    <div class="plugin-grid">
      <div
        v-for="plugin in filteredPlugins"
        :key="plugin.id"
        class="plugin-card"
      >
        <div class="plugin-icon">{{ plugin.icon }}</div>
        <div class="plugin-info">
          <h3>{{ plugin.name }}</h3>
          <p class="plugin-author">by {{ plugin.author }}</p>
          <p class="plugin-description">{{ plugin.description }}</p>
          <div class="plugin-meta">
            <span class="version">v{{ plugin.version }}</span>
            <span class="downloads">â¬‡ï¸ {{ plugin.downloads }}</span>
            <span class="rating">â­ {{ plugin.rating }}</span>
          </div>
        </div>
        <div class="plugin-actions">
          <button
            v-if="!plugin.installed"
            @click="installPlugin(plugin)"
            class="btn-install"
          >
            å®‰è£…
          </button>
          <button
            v-else
            @click="uninstallPlugin(plugin)"
            class="btn-uninstall"
          >
            å¸è½½
          </button>
          <button @click="viewDetails(plugin)" class="btn-details">
            è¯¦æƒ…
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed } from 'vue';

interface MarketPlugin {
  id: string;
  name: string;
  author: string;
  description: string;
  version: string;
  icon: string;
  downloads: number;
  rating: number;
  installed: boolean;
  url: string;
}

const searchQuery = ref('');
const activeTab = ref('all');
const marketPlugins = ref<MarketPlugin[]>([
  {
    id: 'packet-interceptor',
    name: 'å°åŒ…æ‹¦æˆªå™¨',
    author: 'å¤§èƒ†çŒ«çŒ«',
    description: 'æ‹¦æˆªå¹¶åˆ†ææ¸¸æˆå°åŒ…ï¼Œæ”¯æŒå®æ—¶ä¿®æ”¹',
    version: '1.0.0',
    icon: 'ğŸ“¦',
    downloads: 1234,
    rating: 4.8,
    installed: false,
    url: 'https://plugin-server.com/packet-interceptor.zip'
  },
  // æ›´å¤šæ’ä»¶...
]);

const filteredPlugins = computed(() => {
  let plugins = marketPlugins.value;

  if (activeTab.value === 'installed') {
    plugins = plugins.filter(p => p.installed);
  }

  if (searchQuery.value) {
    plugins = plugins.filter(p =>
      p.name.includes(searchQuery.value) ||
      p.description.includes(searchQuery.value)
    );
  }

  return plugins;
});

const installPlugin = async (plugin: MarketPlugin) => {
  try {
    await window.$win.installPlugin(plugin.url);
    plugin.installed = true;
  } catch (error) {
    console.error('å®‰è£…å¤±è´¥:', error);
  }
};

const uninstallPlugin = async (plugin: MarketPlugin) => {
  try {
    await window.$win.uninstallPlugin(plugin.id);
    plugin.installed = false;
  } catch (error) {
    console.error('å¸è½½å¤±è´¥:', error);
  }
};

const viewDetails = (plugin: MarketPlugin) => {
  // æ˜¾ç¤ºæ’ä»¶è¯¦æƒ…
};

const searchPlugins = () => {
  // è§¦å‘æœç´¢
};
</script>

<style scoped>
/* æ ·å¼ä»£ç ... */
</style>
```

---

## ğŸ“¦ å®Œæ•´å®ç°æ­¥éª¤

### Phase 1: æ’ä»¶æ ¸å¿ƒç³»ç»Ÿï¼ˆä¼˜å…ˆçº§æœ€é«˜ï¼‰
- [ ] å®ç°PluginManageræ ¸å¿ƒç±»
- [ ] å®šä¹‰æ’ä»¶æ ‡å‡†æ¥å£
- [ ] å®ç°æ’ä»¶åŠ è½½å’Œæ¿€æ´»æœºåˆ¶
- [ ] å®ç°æ’ä»¶ä¸Šä¸‹æ–‡å’ŒAPI

### Phase 2: ä»£ç ç¼–è¾‘å™¨
- [ ] é›†æˆMonaco Editor
- [ ] å®ç°ä»£ç è¿è¡ŒåŠŸèƒ½
- [ ] å®ç°ä»£ç ä¿å­˜åŠŸèƒ½
- [ ] å®ç°æ§åˆ¶å°è¾“å‡º

### Phase 3: æ’ä»¶å¸‚åœº
- [ ] è®¾è®¡æ’ä»¶å¸‚åœºUI
- [ ] å®ç°æ’ä»¶æœç´¢åŠŸèƒ½
- [ ] å®ç°æ’ä»¶å®‰è£…/å¸è½½
- [ ] å®ç°äº‘ç«¯æ’ä»¶ä¸‹è½½

### Phase 4: å†…ç½®æ’ä»¶ç¤ºä¾‹
- [ ] å°åŒ…æ‹¦æˆªå™¨æ’ä»¶
- [ ] è‡ªåŠ¨æˆ˜æ–—æ’ä»¶
- [ ] æ•°æ®ç»Ÿè®¡æ’ä»¶

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

æˆ‘ç°åœ¨å¯ä»¥å¸®ä½ å®ç°ï¼š
1. **ç«‹å³å¼€å§‹**ï¼šå®ç°æ’ä»¶ç®¡ç†å™¨æ ¸å¿ƒä»£ç 
2. **é›†æˆç¼–è¾‘å™¨**ï¼šæ·»åŠ Monaco Editoråˆ°é¡¹ç›®
3. **è®¾è®¡æ’ä»¶æ ‡å‡†**ï¼šå®Œå–„æ’ä»¶APIå®šä¹‰
4. **å®ç°ç¤ºä¾‹æ’ä»¶**ï¼šåˆ›å»ºå°åŒ…æ‹¦æˆªå™¨ç¤ºä¾‹

**ä½ å¸Œæœ›æˆ‘å…ˆå®ç°å“ªä¸€éƒ¨åˆ†ï¼Ÿ**
